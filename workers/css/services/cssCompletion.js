!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd&&define(["require","exports","../parser/cssNodes","../parser/cssSymbolScope","../languageFacts/facts","../utils/strings","vscode-languageserver-types","vscode-nls"],t)}((function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=t("../parser/cssNodes"),n=t("../parser/cssSymbolScope"),i=t("../languageFacts/facts"),r=t("../utils/strings"),s=t("vscode-languageserver-types"),a=t("vscode-nls").loadMessageBundle(),l=s.InsertTextFormat.Snippet,p=function(){function t(t){void 0===t&&(t=null),this.completionParticipants=[],this.valueTypes=[o.NodeType.Identifier,o.NodeType.Value,o.NodeType.StringLiteral,o.NodeType.URILiteral,o.NodeType.NumericValue,o.NodeType.HexColorValue,o.NodeType.VariableName,o.NodeType.Prio],this.variablePrefix=t}return t.prototype.configure=function(t){this.settings=t},t.prototype.getSymbolContext=function(){return this.symbolContext||(this.symbolContext=new n.Symbols(this.styleSheet)),this.symbolContext},t.prototype.setCompletionParticipants=function(t){this.completionParticipants=t||[]},t.prototype.doComplete=function(t,e,n){this.offset=t.offsetAt(e),this.position=e,this.currentWord=function(t,e){var o=e-1,n=t.getText();for(;o>=0&&-1===' \t\n\r":{[()]},*>+'.indexOf(n.charAt(o));)o--;return n.substring(o+1,e)}(t,this.offset),this.defaultReplaceRange=s.Range.create(s.Position.create(this.position.line,this.position.character-this.currentWord.length),this.position),this.textDocument=t,this.styleSheet=n;try{var i={isIncomplete:!1,items:[]};this.nodePath=o.getNodePath(this.styleSheet,this.offset);for(var r=this.nodePath.length-1;r>=0;r--){var a=this.nodePath[r];if(a instanceof o.Property)this.getCompletionsForDeclarationProperty(a.getParent(),i);else if(a instanceof o.Expression)a.parent instanceof o.Interpolation?this.getVariableProposals(null,i):this.getCompletionsForExpression(a,i);else if(a instanceof o.SimpleSelector){var l=a.findAParent(o.NodeType.ExtendsReference,o.NodeType.Ruleset);if(l)if(l.type===o.NodeType.ExtendsReference)this.getCompletionsForExtendsReference(l,a,i);else{var p=l;this.getCompletionsForSelector(p,p&&p.isNested(),i)}}else if(a instanceof o.FunctionArgument)this.getCompletionsForFunctionArgument(a,a.getParent(),i);else if(a instanceof o.Declarations)this.getCompletionsForDeclarations(a,i);else if(a instanceof o.VariableDeclaration)this.getCompletionsForVariableDeclaration(a,i);else if(a instanceof o.RuleSet)this.getCompletionsForRuleSet(a,i);else if(a instanceof o.Interpolation)this.getCompletionsForInterpolation(a,i);else if(a instanceof o.FunctionDeclaration)this.getCompletionsForFunctionDeclaration(a,i);else if(a instanceof o.MixinReference)this.getCompletionsForMixinReference(a,i);else if(a instanceof o.Function)this.getCompletionsForFunctionArgument(null,a,i);else if(a instanceof o.Supports)this.getCompletionsForSupports(a,i);else if(a instanceof o.SupportsCondition)this.getCompletionsForSupportsCondition(a,i);else if(a instanceof o.ExtendsReference)this.getCompletionsForExtendsReference(a,null,i);else if(a.type===o.NodeType.URILiteral)this.getCompletionForUriLiteralValue(a,i);else if(a.type===o.NodeType.StringLiteral&&a.parent.type===o.NodeType.Import)this.getCompletionForImportPath(a,i);else{if(null!==a.parent)continue;this.getCompletionForTopLevel(i)}if(i.items.length>0||this.offset>a.offset)return this.finalize(i)}return this.getCompletionsForStylesheet(i),0===i.items.length&&this.variablePrefix&&0===this.currentWord.indexOf(this.variablePrefix)&&this.getVariableProposals(null,i),this.finalize(i)}finally{this.position=null,this.currentWord=null,this.textDocument=null,this.styleSheet=null,this.symbolContext=null,this.defaultReplaceRange=null,this.nodePath=null}},t.prototype.finalize=function(t){if(t.items.some((function(t){return!!t.sortText||"-"===t.label[0]})))for(var e=0,o=t.items;e<o.length;e++){var n=o[e];n.sortText||("-"===n.label[0]?n.sortText="x":n.sortText="d")}return t},t.prototype.findInNodePath=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=this.nodePath.length-1;o>=0;o--){var n=this.nodePath[o];if(-1!==t.indexOf(n.type))return n}return null},t.prototype.getCompletionsForDeclarationProperty=function(t,e){return this.getPropertyProposals(t,e)},t.prototype.getPropertyProposals=function(t,e){var o=this,n=this.isTriggerPropertyValueCompletionEnabled;return i.cssDataManager.getProperties().forEach((function(a){var l,p,c=!1;t?(l=o.getCompletionRange(t.getProperty()),p=a.name,m(t.colonPosition)||(p+=": ",c=!0)):(l=o.getCompletionRange(null),p=a.name+": ",c=!0);var u={label:a.name,documentation:i.getEntryDescription(a),textEdit:s.TextEdit.replace(l,p),kind:s.CompletionItemKind.Property};a.restrictions||(c=!1),n&&c&&(u.command={title:"Suggest",command:"editor.action.triggerSuggest"}),r.startsWith(a.name,"-")&&(u.sortText="x"),e.items.push(u)})),this.completionParticipants.forEach((function(t){t.onCssProperty&&t.onCssProperty({propertyName:o.currentWord,range:o.defaultReplaceRange})})),e},Object.defineProperty(t.prototype,"isTriggerPropertyValueCompletionEnabled",{get:function(){return!this.settings||!this.settings.completion||void 0===this.settings.completion.triggerPropertyValueCompletion||this.settings.completion.triggerPropertyValueCompletion},enumerable:!0,configurable:!0}),t.prototype.getCompletionsForDeclarationValue=function(t,e){for(var n=this,r=t.getFullPropertyName(),a=i.cssDataManager.getProperty(r),l=t.getValue();l&&l.hasChildren();)l=l.findChildAtOffset(this.offset,!1);if(this.completionParticipants.forEach((function(t){t.onCssPropertyValue&&t.onCssPropertyValue({propertyName:r,propertyValue:n.currentWord,range:n.getCompletionRange(l)})})),a){if(a.restrictions)for(var p=0,u=a.restrictions;p<u.length;p++){switch(u[p]){case"color":this.getColorProposals(a,l,e);break;case"position":this.getPositionProposals(a,l,e);break;case"repeat":this.getRepeatStyleProposals(a,l,e);break;case"line-style":this.getLineStyleProposals(a,l,e);break;case"line-width":this.getLineWidthProposals(a,l,e);break;case"geometry-box":this.getGeometryBoxProposals(a,l,e);break;case"box":this.getBoxProposals(a,l,e);break;case"image":this.getImageProposals(a,l,e);break;case"timing-function":this.getTimingFunctionProposals(a,l,e);break;case"shape":this.getBasicShapeProposals(a,l,e)}}this.getValueEnumProposals(a,l,e),this.getCSSWideKeywordProposals(a,l,e),this.getUnitProposals(a,l,e)}else for(var f=0,m=function(t,e){var n=e.getFullPropertyName(),i=new c;function r(t){return(t instanceof o.Identifier||t instanceof o.NumericValue||t instanceof o.HexColorValue)&&i.add(t.getText()),!0}return t.accept((function(t){if(t instanceof o.Declaration&&t!==e&&function(t){var e=t.getFullPropertyName();return n===e}(t)){var i=t.getValue();i&&i.accept(r)}return!0})),i}(this.styleSheet,t).getEntries();f<m.length;f++){var h=m[f];e.items.push({label:h,textEdit:s.TextEdit.replace(this.getCompletionRange(l),h),kind:s.CompletionItemKind.Value})}return this.getVariableProposals(l,e),this.getTermProposals(a,l,e),e},t.prototype.getValueEnumProposals=function(t,e,o){if(t.values)for(var n=0,a=t.values;n<a.length;n++){var p=a[n],c=p.name,u=void 0;if(r.endsWith(c,")")){var f=c.lastIndexOf("(");-1!==f&&(c=c.substr(0,f)+"($1)",u=l)}var m={label:p.name,documentation:i.getEntryDescription(p),textEdit:s.TextEdit.replace(this.getCompletionRange(e),c),kind:s.CompletionItemKind.Value,insertTextFormat:u};o.items.push(m)}return o},t.prototype.getCSSWideKeywordProposals=function(t,e,o){for(var n in i.cssWideKeywords)o.items.push({label:n,documentation:i.cssWideKeywords[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Value});return o},t.prototype.getCompletionsForInterpolation=function(t,e){return this.offset>=t.offset+2&&this.getVariableProposals(null,e),e},t.prototype.getVariableProposals=function(t,e){for(var n=0,i=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Variable);n<i.length;n++){var l=i[n],p=r.startsWith(l.name,"--")?"var("+l.name+")":l.name,c={label:l.name,documentation:l.value?r.getLimitedString(l.value):l.value,textEdit:s.TextEdit.replace(this.getCompletionRange(t),p),kind:s.CompletionItemKind.Variable,sortText:"z"};if(l.node.type===o.NodeType.FunctionParameter){var u=l.node.getParent();u.type===o.NodeType.MixinDeclaration&&(c.detail=a("completion.argument","argument from '{0}'",u.getName()))}e.items.push(c)}return e},t.prototype.getVariableProposalsForCSSVarFunction=function(t){for(var e=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Variable),n=0,i=e=e.filter((function(t){return r.startsWith(t.name,"--")}));n<i.length;n++){var a=i[n];t.items.push({label:a.name,documentation:a.value?r.getLimitedString(a.value):a.value,textEdit:s.TextEdit.replace(this.getCompletionRange(null),a.name),kind:s.CompletionItemKind.Variable})}return t},t.prototype.getUnitProposals=function(t,e,n){var r="0";if(this.currentWord.length>0){var a=this.currentWord.match(/^-?\d[\.\d+]*/);a&&(r=a[0],n.isIncomplete=r.length===this.currentWord.length)}else 0===this.currentWord.length&&(n.isIncomplete=!0);if(e&&e.parent&&e.parent.type===o.NodeType.Term&&(e=e.getParent()),t.restrictions)for(var l=0,p=t.restrictions;l<p.length;l++){var c=p[l],u=i.units[c];if(u)for(var f=0,m=u;f<m.length;f++){var h=r+m[f];n.items.push({label:h,textEdit:s.TextEdit.replace(this.getCompletionRange(e),h),kind:s.CompletionItemKind.Unit})}}return n},t.prototype.getCompletionRange=function(t){if(t&&t.offset<=this.offset){var e=-1!==t.end?this.textDocument.positionAt(t.end):this.position;return s.Range.create(this.textDocument.positionAt(t.offset),e)}return this.defaultReplaceRange},t.prototype.getColorProposals=function(t,e,o){for(var n in i.colors)o.items.push({label:n,documentation:i.colors[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Color});for(var n in i.colorKeywords)o.items.push({label:n,documentation:i.colorKeywords[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Value});var r=new c;this.styleSheet.acceptVisitor(new f(r,this.offset));for(var a=0,p=r.getEntries();a<p.length;a++){n=p[a];o.items.push({label:n,textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Color})}for(var u=function(t){var n=1,i=t.func.replace(/\[?\$(\w+)\]?/g,(function(t,e){return"${"+n+++":"+e+"}"}));o.items.push({label:t.func.substr(0,t.func.indexOf("(")),detail:t.func,documentation:t.desc,textEdit:s.TextEdit.replace(m.getCompletionRange(e),i),insertTextFormat:l,kind:s.CompletionItemKind.Function})},m=this,h=0,g=i.colorFunctions;h<g.length;h++){u(g[h])}return o},t.prototype.getPositionProposals=function(t,e,o){for(var n in i.positionKeywords)o.items.push({label:n,documentation:i.positionKeywords[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Value});return o},t.prototype.getRepeatStyleProposals=function(t,e,o){for(var n in i.repeatStyleKeywords)o.items.push({label:n,documentation:i.repeatStyleKeywords[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Value});return o},t.prototype.getLineStyleProposals=function(t,e,o){for(var n in i.lineStyleKeywords)o.items.push({label:n,documentation:i.lineStyleKeywords[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Value});return o},t.prototype.getLineWidthProposals=function(t,e,o){for(var n=0,r=i.lineWidthKeywords;n<r.length;n++){var a=r[n];o.items.push({label:a,textEdit:s.TextEdit.replace(this.getCompletionRange(e),a),kind:s.CompletionItemKind.Value})}return o},t.prototype.getGeometryBoxProposals=function(t,e,o){for(var n in i.geometryBoxKeywords)o.items.push({label:n,documentation:i.geometryBoxKeywords[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Value});return o},t.prototype.getBoxProposals=function(t,e,o){for(var n in i.boxKeywords)o.items.push({label:n,documentation:i.boxKeywords[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),n),kind:s.CompletionItemKind.Value});return o},t.prototype.getImageProposals=function(t,e,o){for(var n in i.imageFunctions){var r=u(n);o.items.push({label:n,documentation:i.imageFunctions[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),r),kind:s.CompletionItemKind.Function,insertTextFormat:n!==r?l:void 0})}return o},t.prototype.getTimingFunctionProposals=function(t,e,o){for(var n in i.transitionTimingFunctions){var r=u(n);o.items.push({label:n,documentation:i.transitionTimingFunctions[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),r),kind:s.CompletionItemKind.Function,insertTextFormat:n!==r?l:void 0})}return o},t.prototype.getBasicShapeProposals=function(t,e,o){for(var n in i.basicShapeFunctions){var r=u(n);o.items.push({label:n,documentation:i.basicShapeFunctions[n],textEdit:s.TextEdit.replace(this.getCompletionRange(e),r),kind:s.CompletionItemKind.Function,insertTextFormat:n!==r?l:void 0})}return o},t.prototype.getCompletionsForStylesheet=function(t){var e=this.styleSheet.findFirstChildBeforeOffset(this.offset);return e?e instanceof o.RuleSet?this.getCompletionsForRuleSet(e,t):e instanceof o.Supports?this.getCompletionsForSupports(e,t):t:this.getCompletionForTopLevel(t)},t.prototype.getCompletionForTopLevel=function(t){var e=this;return i.cssDataManager.getAtDirectives().forEach((function(o){t.items.push({label:o.name,textEdit:s.TextEdit.replace(e.getCompletionRange(null),o.name),documentation:i.getEntryDescription(o),kind:s.CompletionItemKind.Keyword})})),this.getCompletionsForSelector(null,!1,t),t},t.prototype.getCompletionsForRuleSet=function(t,e){var o=t.getDeclarations();return o&&o.endsWith("}")&&this.offset>=o.end?this.getCompletionForTopLevel(e):!o||this.offset<=o.offset?this.getCompletionsForSelector(t,t.isNested(),e):this.getCompletionsForDeclarations(t.getDeclarations(),e)},t.prototype.getCompletionsForSelector=function(t,e,n){var a=this,p=this.findInNodePath(o.NodeType.PseudoSelector,o.NodeType.IdentifierSelector,o.NodeType.ClassSelector,o.NodeType.ElementNameSelector);if(!p&&this.offset-this.currentWord.length>0&&":"===this.textDocument.getText()[this.offset-this.currentWord.length-1]&&(this.currentWord=":"+this.currentWord,this.defaultReplaceRange=s.Range.create(s.Position.create(this.position.line,this.position.character-this.currentWord.length),this.position)),i.cssDataManager.getPseudoClasses().forEach((function(t){var e=u(t.name),o={label:t.name,textEdit:s.TextEdit.replace(a.getCompletionRange(p),e),documentation:i.getEntryDescription(t),kind:s.CompletionItemKind.Function,insertTextFormat:t.name!==e?l:void 0};r.startsWith(t.name,":-")&&(o.sortText="x"),n.items.push(o)})),i.cssDataManager.getPseudoElements().forEach((function(t){var e=u(t.name),o={label:t.name,textEdit:s.TextEdit.replace(a.getCompletionRange(p),e),documentation:i.getEntryDescription(t),kind:s.CompletionItemKind.Function,insertTextFormat:t.name!==e?l:void 0};r.startsWith(t.name,"::-")&&(o.sortText="x"),n.items.push(o)})),!e){for(var c=0,f=i.html5Tags;c<f.length;c++){var m=f[c];n.items.push({label:m,textEdit:s.TextEdit.replace(this.getCompletionRange(p),m),kind:s.CompletionItemKind.Keyword})}for(var h=0,g=i.svgElements;h<g.length;h++){m=g[h];n.items.push({label:m,textEdit:s.TextEdit.replace(this.getCompletionRange(p),m),kind:s.CompletionItemKind.Keyword})}}var d={};d[this.currentWord]=!0;var y=this.styleSheet.getTextProvider();if(this.styleSheet.accept((function(t){if(t.type===o.NodeType.SimpleSelector&&t.length>0){var e=y(t.offset,t.length);return"."!==e.charAt(0)||d[e]||(d[e]=!0,n.items.push({label:e,textEdit:s.TextEdit.replace(a.getCompletionRange(p),e),kind:s.CompletionItemKind.Keyword})),!1}return!0})),t&&t.isNested()){var C=t.getSelectors().findFirstChildBeforeOffset(this.offset);C&&0===t.getSelectors().getChildren().indexOf(C)&&this.getPropertyProposals(null,n)}return n},t.prototype.getCompletionsForDeclarations=function(t,e){if(!t||this.offset===t.offset)return e;var n=t.findFirstChildBeforeOffset(this.offset);if(!n)return this.getCompletionsForDeclarationProperty(null,e);if(n instanceof o.AbstractDeclaration){var i=n;if(!m(i.colonPosition)||this.offset<=i.colonPosition)return this.getCompletionsForDeclarationProperty(i,e);if(m(i.semicolonPosition)&&i.semicolonPosition<this.offset)return this.offset===i.semicolonPosition+1?e:this.getCompletionsForDeclarationProperty(null,e);if(i instanceof o.Declaration)return this.getCompletionsForDeclarationValue(i,e)}else n instanceof o.ExtendsReference?this.getCompletionsForExtendsReference(n,null,e):this.currentWord&&"@"===this.currentWord[0]&&this.getCompletionsForDeclarationProperty(null,e);return e},t.prototype.getCompletionsForVariableDeclaration=function(t,e){return this.offset>t.colonPosition&&this.getVariableProposals(t.getValue(),e),e},t.prototype.getCompletionsForExpression=function(t,e){if(t.getParent()instanceof o.FunctionArgument)return this.getCompletionsForFunctionArgument(t.getParent(),t.getParent().getParent(),e),e;var n=t.findParent(o.NodeType.Declaration);if(!n)return this.getTermProposals(null,null,e),e;var i=t.findChildAtOffset(this.offset,!0);return i?i instanceof o.NumericValue||i instanceof o.Identifier?this.getCompletionsForDeclarationValue(n,e):e:this.getCompletionsForDeclarationValue(n,e)},t.prototype.getCompletionsForFunctionArgument=function(t,e,o){return"var"===e.getIdentifier().getText()&&(e.getArguments().hasChildren()&&e.getArguments().getChild(0)!==t||this.getVariableProposalsForCSSVarFunction(o)),o},t.prototype.getCompletionsForFunctionDeclaration=function(t,e){var o=t.getDeclarations();return o&&this.offset>o.offset&&this.offset<o.end&&this.getTermProposals(null,null,e),e},t.prototype.getCompletionsForMixinReference=function(t,e){for(var n=0,i=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Mixin);n<i.length;n++){var r=i[n];r.node instanceof o.MixinDeclaration&&e.items.push(this.makeTermProposal(r,r.node.getParameters(),null))}return e},t.prototype.getTermProposals=function(t,e,n){for(var i=0,r=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Function);i<r.length;i++){var s=r[i];s.node instanceof o.FunctionDeclaration&&n.items.push(this.makeTermProposal(s,s.node.getParameters(),e))}return n},t.prototype.makeTermProposal=function(t,e,n){t.node;var i=e.getChildren().map((function(t){return t instanceof o.FunctionParameter?t.getName():t.getText()})),r=t.name+"("+i.map((function(t,e){return"${"+(e+1)+":"+t+"}"})).join(", ")+")";return{label:t.name,detail:t.name+"("+i.join(", ")+")",textEdit:s.TextEdit.replace(this.getCompletionRange(n),r),insertTextFormat:l,kind:s.CompletionItemKind.Function,sortText:"z"}},t.prototype.getCompletionsForSupportsCondition=function(t,e){var n=t.findFirstChildBeforeOffset(this.offset);if(n){if(n instanceof o.Declaration)return m(n.colonPosition||this.offset<=n.colonPosition)?this.getCompletionsForDeclarationValue(n,e):this.getCompletionsForDeclarationProperty(n,e);if(n instanceof o.SupportsCondition)return this.getCompletionsForSupportsCondition(n,e)}return m(t.lParent)&&this.offset>t.lParent&&(!m(t.rParent)||this.offset<=t.rParent)?this.getCompletionsForDeclarationProperty(null,e):e},t.prototype.getCompletionsForSupports=function(t,e){var n=t.getDeclarations();if(!n||this.offset<=n.offset){var i=t.findFirstChildBeforeOffset(this.offset);return i instanceof o.SupportsCondition?this.getCompletionsForSupportsCondition(i,e):e}return this.getCompletionForTopLevel(e)},t.prototype.getCompletionsForExtendsReference=function(t,e,o){return o},t.prototype.getCompletionForUriLiteralValue=function(t,e){var o,n,i;if(0===t.getChildren().length){o="",n=this.position;var r=this.textDocument.positionAt(t.offset+"url(".length);i=s.Range.create(r,r)}else{var a=t.getChild(0);o=a.getText(),n=this.position,i=this.getCompletionRange(a)}return this.completionParticipants.forEach((function(t){t.onCssURILiteralValue&&t.onCssURILiteralValue({uriValue:o,position:n,range:i})})),e},t.prototype.getCompletionForImportPath=function(t,e){var o=this;return this.completionParticipants.forEach((function(e){e.onCssImportPath&&e.onCssImportPath({pathValue:t.getText(),position:o.position,range:o.getCompletionRange(t)})})),e},t}();e.CSSCompletion=p;var c=function(){function t(){this.entries={}}return t.prototype.add=function(t){this.entries[t]=!0},t.prototype.getEntries=function(){return Object.keys(this.entries)},t}();function u(t){return t.replace(/\(\)$/,"($1)")}var f=function(){function t(t,e){this.entries=t,this.currentOffset=e}return t.prototype.visitNode=function(t){return(t instanceof o.HexColorValue||t instanceof o.Function&&i.isColorConstructor(t))&&(this.currentOffset<t.offset||t.end<this.currentOffset)&&this.entries.add(t.getText()),!0},t}();function m(t){return void 0!==t}}));